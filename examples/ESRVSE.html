<!DOCTYPE html>
<html lang="en">
<head>
    <title>AR Experience</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script type="importmap">
        {
            "imports": {
                "three": "../build/three.module.js",
                "three/addons/": "./jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="info">
        <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> xr - controls - transform
    </div>

    <button class="startButton" id="startButton1" disabled>Start Experience</button>
    <button id="resetButton" style="display: none;">Reset Experience</button>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { XRButton } from 'three/addons/webxr/XRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        let container;
        let camera, scene, renderer;
        let controller1, controller2, line;
        let controllerGrip1, controllerGrip2;
        let raycaster;

        let controls, court;

        const audioSources = [];
        let mixer, video, videoTexture;
        let startButtonEnabled = false;
		let isGLBLoaded = false;
		let isVideoLoaded = false;
		let allAudioLoaded = false;
		let audioLoadedCount = 0;
		


        init();
        animate();

        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x808080);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 10);
            camera.position.set(0, 1.6, 0);

            const floorGeometry = new THREE.PlaneGeometry(6, 6);
            const floorMaterial = new THREE.ShadowMaterial({ opacity: 0.25, blending: THREE.CustomBlending, transparent: false });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            scene.add(new THREE.HemisphereLight(0xbcbcbc, 0xa5a5a5, 3));

            const light = new THREE.DirectionalLight(0xffffff, 3);
            light.position.set(0, 6, 0);
            light.castShadow = true;
            light.shadow.camera.top = 3;
            light.shadow.camera.bottom = -3;
            light.shadow.camera.right = 3;
            light.shadow.camera.left = -3;
            light.shadow.mapSize.set(4096, 4096);
            scene.add(light);

const loader = new GLTFLoader();
let mixer;
loader.load('https://uploads-ssl.webflow.com/62585c8f3b855d70abac2fff/66464fdbb596dafdc5a82406_rtvse-asd.glb.txt', function (gltf) {
    if (gltf && gltf.scene) {
        court = gltf.scene;
        court.scale.set(0.1, 0.1, 0.1); // Set the scale to 0.1 for AR
        scene.add(court);

        // Animation Mixer
        mixer = new THREE.AnimationMixer(court);
        gltf.animations.forEach((clip) => {
            mixer.clipAction(clip).play();
        });

        court.traverse((child) => {
            if (child.isMesh) {
                const index = modelIDs.indexOf(child.name);
                if (index !== -1) {
                    audioLoader.load(audioUrls[index], (buffer) => {
                        const audio = new THREE.PositionalAudio(listener);
                        audio.setBuffer(buffer);
                        audio.setRefDistance(1);
                        audio.setDistanceModel('exponential');
                        audio.setRolloffFactor(2.5);
                        child.add(audio);
                        audioSources.push(audio);

                        // Increment the loaded count and check if all audio is loaded
                        audioLoadedCount++;
                        if (audioLoadedCount === audioUrls.length) {
                            allAudioLoaded = true;
                            checkAllLoaded();
                        }
                    }, undefined, function (error) {
                        console.error(`Error loading audio for model ${child.name}:`, error);
                    });
                }
            }
        });

        // Once the model is loaded, set the flag and check all resources
        isGLBLoaded = true;
        checkAllLoaded();
    } else {
        console.error('Failed to load GLTF model.');
    }
}, undefined, function (error) {
    console.error('An error occurred while loading the GLTF model:', error);
});


            // Video setup
            video = document.createElement('video');
            video.src = 'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NBA_AllStar_Demo_Clip%20(2).mp4';
            video.crossOrigin = "anonymous";
            video.preload = 'auto';
            video.load();
            video.muted = true;
            videoTexture = new THREE.VideoTexture(video);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            videoTexture.format = THREE.RGBAFormat;

            const geometry = new THREE.PlaneGeometry(4, 2.25);
            const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
            const videoScreen = new THREE.Mesh(geometry, material);
            videoScreen.position.set(0, 2, -5);
            videoScreen.scale.set(-1, 1, 1);
            scene.add(videoScreen);

            // Audio setup
            const listener = new THREE.AudioListener();
            camera.add(listener);

            const audioUrls = [
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Ball_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player1_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player2_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player3_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player4_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player5_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player6_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NetL_Stem.mp3',
                'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NetR_Stem.mp3'
            ];
            const modelIDs = ['1', '2', '3', '4', '5', '6', '7', 'basket1', 'basket2'];
            const audioLoader = new THREE.AudioLoader();
            const nonSpatialAudioUrl = 'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/AllStar_Game_FOH.mp3';
            const nonSpatialAudio = new THREE.Audio(listener);
            const nonSpatialAudioLoader = new THREE.AudioLoader();
            nonSpatialAudioLoader.load(nonSpatialAudioUrl, (buffer) => {
                nonSpatialAudio.setVolume(1);
                listener.add(nonSpatialAudio);
                audioSources.push(nonSpatialAudio);
            });

            // Attach audio sources to GLTF model
            function attachAudioSources() {
                court.traverse((child) => {
                    const index = modelIDs.indexOf(child.name);
                    if (index !== -1) {
                        audioLoader.load(audioUrls[index], (buffer) => {
                            const audio = new THREE.PositionalAudio(listener);
                            audio.setBuffer(buffer);
                            audio.setRefDistance(1);
                            audio.setDistanceModel('exponential');
                            audio.setRolloffFactor(2.5);
                            child.add(audio);
                            audioSources.push(audio);
                        }, undefined, function (error) {
                            console.error(`Error loading audio for model ${child.name}:`, error);
                        });
                    }
                });
            }

            attachAudioSources();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            document.body.appendChild(XRButton.createButton(renderer));

            // Controllers setup
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('select', onSelect);
            scene.add(controller1);

            controller2 = renderer.xr.getController(1);
            controller2.addEventListener('select', onSelect);
            scene.add(controller2);

            const controllerModelFactory = new XRControllerModelFactory();

            controllerGrip1 = renderer.xr.getControllerGrip(0);
            controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
            scene.add(controllerGrip1);

            controllerGrip2 = renderer.xr.getControllerGrip(1);
            controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
            scene.add(controllerGrip2);

            const lineGeometry = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -1)]);
            line = new THREE.Line(lineGeometry);
            line.name = 'line';
            line.scale.z = 5;

            raycaster = new THREE.Raycaster();

            // Controls setup
            controls = new TransformControls(camera, renderer.domElement);
            scene.add(controls);

            window.addEventListener('resize', onWindowResize);

            // Create buttons
            createButtons();

            document.getElementById('startButton1').addEventListener('click', startExperience);
            document.getElementById('resetButton').addEventListener('click', restartExperience);

            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    stopExperience();
                }
            });
        }

        function createButtons() {
            const playButton = makeButtonMesh(0.2, 0.1, 0.01, 0x00ff00);
            playButton.position.set(0, 1, -1);
            scene.add(playButton);

            const pauseButton = makeButtonMesh(0.2, 0.1, 0.01, 0xffff00);
            pauseButton.position.set(0, 1.2, -1);
            scene.add(pauseButton);

            const restartButton = makeButtonMesh(0.2, 0.1, 0.01, 0xff0000);
            restartButton.position.set(0, 1.4, -1);
            scene.add(restartButton);

            playButton.userData.action = startExperience;
            pauseButton.userData.action = pauseExperience;
            restartButton.userData.action = restartExperience;
        }

        function onSelect(event) {
            const controller = event.target;
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            const intersects = raycaster.intersectObjects(scene.children);

            if (intersects.length > 0) {
                const intersect = intersects[0];
                if (intersect.object.userData.action) {
                    intersect.object.userData.action();
                }
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = clock.getDelta();
            if (mixer) {
                mixer.update(delta);
            }
            renderer.render(scene, camera);
        }

        function checkAllLoaded() {
            if (!startButtonEnabled) {
                startButtonEnabled = true;
                const startButton1 = document.getElementById('startButton1');
                if (startButton1) {
                    startButton1.disabled = false;
                }
            }
        }

        function startExperience() {
            if (mixer) {
                mixer._actions.forEach(action => {
                    action.paused = false;
                    action.play();
                });
            }
            audioSources.forEach(audio => {
                if (!audio.isPlaying) {
                    audio.play();
                }
            });
            if (video && video.paused) {
                video.play();
            }
            document.getElementById('resetButton').style.display = 'block';
            document.querySelectorAll('.startButton').forEach(button => {
                button.style.display = 'none';
            });
        }

        function pauseExperience() {
            if (mixer) {
                mixer._actions.forEach(action => {
                    action.paused = true;
                });
            }
            audioSources.forEach(audio => audio.pause());
            if (video && !video.paused) {
                video.pause();
            }
        }

        function restartExperience() {
            stopExperience();
            startExperience();
        }

        function stopExperience() {
            if (mixer) {
                mixer.stopAllAction();
                mixer._actions.forEach(action => {
                    action.stop();
                    action.reset();
                });
            }
            audioSources.forEach(audio => audio.stop());
            if (video) {
                video.pause();
                video.currentTime = 0;
            }
        }
    </script>
</body>
</html>
