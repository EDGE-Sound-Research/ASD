<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Experience</title>
    <script type="importmap">
        {
            "imports": {
                "three": "../build/three.module.js",
                "three/addons/": "./jsm/"
            }
        }
    </script>
</head>
<body>
    <button class="startButton" id="startButton1" disabled>Start Experience</button>
    <button id="resetButton">Reset Experience</button>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

        let camera, scene, renderer;
        let controller1, controller2, controllerGrip1, controllerGrip2;
        let controls, court, mixer;
        const audioSources = [];
        const clock = new THREE.Clock();
        const audioLoader = new THREE.AudioLoader();
        let isGLBLoaded = false;
        let isVideoLoaded = false;
        let allAudioLoaded = false;
        let audioLoadedCount = 0;

        // VIDEO SETUP
        const video = document.createElement('video');
        video.crossOrigin = "anonymous";
        video.preload = 'auto';
        video.src = 'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NBA_AllStar_Demo_Clip%20(2).mp4';
        const videoTexture = new THREE.VideoTexture(video);
        const geometry = new THREE.PlaneGeometry(4, 2.25);
        const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
        const videoScreen = new THREE.Mesh(geometry, material);
        videoScreen.position.set(0, 2, -5);
        videoScreen.rotation.y = Math.PI;
        videoScreen.scale.set(-1, 1, 1);

        // SCENE SETUP
        scene = new THREE.Scene();
        scene.add(videoScreen);

        camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType('local-floor');
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test', 'hand-tracking'] }));
        scene.background = null;
        const listener = new THREE.AudioListener();
        camera.add(listener);
        camera.position.set(0, 2, 6);

        // LOAD GLTF MODEL
        const loader = new GLTFLoader();
        loader.load('https://uploads-ssl.webflow.com/62585c8f3b855d70abac2fff/66464fdbb596dafdc5a82406_rtvse-asd.glb.txt', function (gltf) {
            court = gltf.scene;
            court.scale.set(0.1, 0.1, 0.1);
            scene.add(court);
            mixer = new THREE.AnimationMixer(court);
            gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
            court.traverse((child) => {
                const audioUrls = [
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Ball_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player1_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player2_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player3_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player4_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player5_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/Player6_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NetL_Stem.mp3',
                    'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/NetR_Stem.mp3'
                ];
                const modelIDs = ['1', '2', '3', '4', '5', '6', '7', 'basket1', 'basket2'];
                const index = modelIDs.indexOf(child.name);
                if (index !== -1) {
                    audioLoader.load(audioUrls[index], (buffer) => {
                        const audio = new THREE.PositionalAudio(listener);
                        audio.setBuffer(buffer);
                        audio.setRefDistance(1);
                        audio.setDistanceModel('exponential');
                        audio.setRolloffFactor(2.5);
                        child.add(audio);
                        audioSources.push(audio);
                        audioLoadedCount++;
                        if (audioLoadedCount === audioUrls.length) {
                            allAudioLoaded = true;
                            checkAllLoaded();
                        }
                    });
                }
            });
            isGLBLoaded = true;
            checkAllLoaded();
        });

        // HAND TRACKING SETUP
        const handModelFactory = new XRHandModelFactory();
        const controllerModelFactory = new XRControllerModelFactory();

        controller1 = renderer.xr.getController(0);
        controller1.addEventListener('selectstart', onSelectStart);
        controller1.addEventListener('selectend', onSelectEnd);
        scene.add(controller1);

        controller2 = renderer.xr.getController(1);
        controller2.addEventListener('selectstart', onSelectStart);
        controller2.addEventListener('selectend', onSelectEnd);
        scene.add(controller2);

        controllerGrip1 = renderer.xr.getControllerGrip(0);
        controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
        scene.add(controllerGrip1);

        controllerGrip2 = renderer.xr.getControllerGrip(1);
        controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
        scene.add(controllerGrip2);

        const hand1 = renderer.xr.getHand(0);
        hand1.add(handModelFactory.createHandModel(hand1));
        scene.add(hand1);

        const hand2 = renderer.xr.getHand(1);
        hand2.add(handModelFactory.createHandModel(hand2));
        scene.add(hand2);

        // TRANSFORM CONTROLS
        controls = new TransformControls(camera, renderer.domElement);
        controls.addEventListener('change', () => renderer.render(scene, camera));
        controls.attach(court);
        scene.add(controls);

        // AUDIO SETUP
        const nonSpatialAudioUrl = 'https://raw.githubusercontent.com/zpennachi/ESR-VSE_DEMO/main/AllStar_Game_FOH.mp3';
        const nonSpatialAudio = new THREE.Audio(listener);
        const nonSpatialAudioLoader = new THREE.AudioLoader();
        nonSpatialAudioLoader.load(nonSpatialAudioUrl, (buffer) => {
            nonSpatialAudio.setBuffer(buffer);
            nonSpatialAudio.setVolume(1);
            listener.add(nonSpatialAudio);
            audioSources.push(nonSpatialAudio);
        });

        // LIGHTS SETUP
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(0, 20, 10);
        scene.add(directionalLight);

        // START BUTTON
        document.getElementById('startButton1').addEventListener('click', startButtonFunctionality);
        document.getElementById('resetButton').addEventListener('click', resetExperience);

        function checkAllLoaded() {
            if (isGLBLoaded && isVideoLoaded && allAudioLoaded) {
                document.getElementById('startButton1').disabled = false;
            }
        }

        function animate() {
            renderer.setAnimationLoop(() => {
                const delta = clock.getDelta();
                if (mixer) mixer.update(delta);
                if (video.readyState >= video.HAVE_CURRENT_DATA) videoTexture.needsUpdate = true;
                renderer.render(scene, camera);
            });
        }

        function startButtonFunctionality() {
            document.querySelectorAll('.startButton').forEach(button => {
                button.style.display = 'none';
            });
            const audioContext = THREE.AudioContext.getContext();
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    audioSources.forEach(audio => audio.play());
                    video.play();
                });
            } else {
                audioSources.forEach(audio => audio.play());
                video.play();
            }
            startExperience();
        }

        function resetExperience() {
            stopExperience();
            startExperience();
        }

        function stopExperience() {
            if (mixer) {
                mixer.stopAllAction();
                mixer._actions.forEach(action => action.stop());
            }
            audioSources.forEach(audio => audio.stop());
            video.pause();
            video.currentTime = 0;
        }

        function startExperience() {
            if (mixer) {
                mixer.stopAllAction();
                mixer.update(0);
                mixer._actions.forEach(action => {
                    action.reset();
                    action.play();
                });
            }
            audioSources.forEach(audio => {
                if (!audio.isPlaying) audio.play();
            });
            video.play();
            animate();
        }

        video.addEventListener('canplaythrough', () => {
            isVideoLoaded = true;
            checkAllLoaded();
        });

        if (video.readyState >= 4) {
            isVideoLoaded = true;
            checkAllLoaded();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize, false);

        function onSelectStart(event) {
            const controller = event.target;
            const intersections = getIntersections(controller);
            if (intersections.length > 0) {
                const intersection = intersections[0];
                const object = intersection.object;
                controls.attach(object);
                controller.userData.selected = object;
            }
        }

        function onSelectEnd(event) {
            const controller = event.target;
            if (controller.userData.selected !== undefined) {
                controls.detach();
                controller.userData.selected = undefined;
            }
        }

        function getIntersections(controller) {
            const tempMatrix = new THREE.Matrix4();
            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
            return raycaster.intersectObjects(scene.children);
        }
    </script>
</body>
</html>
